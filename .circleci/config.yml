version: 2.1

orbs:
  qlty: qltysh/qlty-orb@0.0.10

rabbitmq: &rabbitmq
  image: rabbitmq:3.11-alpine

restore: &restore
  restore_cache:
    key: deps-{{ checksum "package-lock.json" }}

cache: &cache
  save_cache:
    key: deps-{{ checksum "package-lock.json" }}
    paths:
      - node_modules/

make: &make
  run:
    name: Install GNU Make
    command: apk add make --no-cache

wait: &wait
  run:
    name: Wait For RabbitMQ To Start
    command: until nc -z 127.0.0.1 5672; do sleep 1; done

test: &test
  steps:
    - checkout
    - *restore
    - *make
    - run:
        name: Install Dependencies
        command: make deps
    - *cache
    - *wait
    - run:
        name: Run Tests
        command: make types test

jobs:
  lint:
    docker:
      - image: node:24-alpine
    steps:
      - checkout
      - run:
          name: Install ESLint
          command: npm install --no-save eslint@^8.9.0
      - *make
      - run:
          name: Run ESLint
          command: make lint

  node24:
    docker:
      - image: node:24-alpine
      - *rabbitmq
    <<: *test

  node22:
    docker:
      - image: node:22-alpine
      - *rabbitmq
    <<: *test

  node20:
    docker:
      - image: node:20-alpine
      - *rabbitmq
    <<: *test

  coverage:
    docker:
      - image: node:24-alpine
      - *rabbitmq
    steps:
      - checkout
      - *restore
      - *make
      - run:
          name: Install Dependencies
          command: make deps
      - *cache
      - *wait
      - run:
          name: Run Tests & Calculate Coverage
          command: make coverage

      - persist_to_workspace:
          root: coverage
          paths:
            - lcov.info

  report_coverage:
    docker:
      - image: cimg/node:24.4
    steps:
      - checkout
      - attach_workspace:
          at: coverage
      - qlty/coverage_publish:
          files: coverage/lcov.info

workflows:
  version: 2
  build:
    jobs:
      - lint
      - node24:
          requires:
            - lint
      - node22:
          requires:
            - lint
      - node20:
          requires:
            - lint
      - coverage:
          context: qlty
          requires:
            - lint
      - report_coverage:
          requires:
            - coverage
